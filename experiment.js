// Shape Rating Experiment
// 600 trials: each model generation paired with its source image

// Define exact source images that exist (based on your provided list)
const SOURCE_IMAGES = [
    {stimId: 131, naturalNovel: 0, symmetry: 1, length: 0},
    {stimId: 131, naturalNovel: 1, symmetry: 1, length: 0},
    {stimId: 132, naturalNovel: 0, symmetry: 1, length: 1},
    {stimId: 132, naturalNovel: 1, symmetry: 1, length: 1},
    {stimId: 133, naturalNovel: 0, symmetry: 1, length: 1},
    {stimId: 133, naturalNovel: 1, symmetry: 1, length: 1},
    {stimId: 134, naturalNovel: 0, symmetry: 1, length: 0},
    {stimId: 134, naturalNovel: 1, symmetry: 1, length: 0},
    {stimId: 135, naturalNovel: 0, symmetry: 0, length: 0},
    {stimId: 135, naturalNovel: 1, symmetry: 0, length: 0},
    {stimId: 136, naturalNovel: 0, symmetry: 0, length: 1},
    {stimId: 136, naturalNovel: 1, symmetry: 0, length: 1},
    {stimId: 137, naturalNovel: 0, symmetry: 0, length: 0},
    {stimId: 137, naturalNovel: 1, symmetry: 0, length: 0},
    {stimId: 138, naturalNovel: 0, symmetry: 0, length: 1},
    {stimId: 138, naturalNovel: 1, symmetry: 0, length: 1},
    {stimId: 139, naturalNovel: 0, symmetry: 1, length: 1},
    {stimId: 139, naturalNovel: 1, symmetry: 1, length: 1},
    {stimId: 140, naturalNovel: 0, symmetry: 1, length: 0},
    {stimId: 140, naturalNovel: 1, symmetry: 1, length: 0},
    {stimId: 141, naturalNovel: 0, symmetry: 1, length: 1},
    {stimId: 141, naturalNovel: 1, symmetry: 1, length: 1},
    {stimId: 142, naturalNovel: 0, symmetry: 0, length: 1},
    {stimId: 142, naturalNovel: 1, symmetry: 0, length: 1},
    {stimId: 143, naturalNovel: 0, symmetry: 0, length: 1},
    {stimId: 143, naturalNovel: 1, symmetry: 0, length: 1},
    {stimId: 144, naturalNovel: 0, symmetry: 1, length: 1},
    {stimId: 144, naturalNovel: 1, symmetry: 1, length: 1},
    {stimId: 145, naturalNovel: 0, symmetry: 0, length: 1},
    {stimId: 145, naturalNovel: 1, symmetry: 0, length: 1},
    {stimId: 146, naturalNovel: 0, symmetry: 0, length: 0},
    {stimId: 146, naturalNovel: 1, symmetry: 0, length: 0},
    {stimId: 147, naturalNovel: 0, symmetry: 1, length: 0},
    {stimId: 147, naturalNovel: 1, symmetry: 1, length: 0},
    {stimId: 148, naturalNovel: 0, symmetry: 1, length: 0},
    {stimId: 148, naturalNovel: 1, symmetry: 1, length: 0},
    {stimId: 149, naturalNovel: 0, symmetry: 0, length: 0},
    {stimId: 149, naturalNovel: 1, symmetry: 0, length: 0},
    {stimId: 150, naturalNovel: 0, symmetry: 0, length: 0},
    {stimId: 150, naturalNovel: 1, symmetry: 0, length: 0}
];

const MODELS = ['GROK', 'GEMINI', 'GPT'];
const ITERATIONS = {
    'GEMINI': [1, 2, 3, 4, 5],
    'GPT': [1, 2, 3, 4, 5]
};

// Hardcoded GROK file availability (based on your console output)
const GROK_AVAILABILITY = {
    '131_0_1_0': [1, 2, 3, 5, 6],
    '131_1_1_0': [1, 2, 3, 4, 6],
    '132_0_1_1': [1, 2, 3, 5, 6],
    '132_1_1_1': [1, 2, 3, 4, 5],
    '133_0_1_1': [1, 2, 4, 5, 6],
    '133_1_1_1': [1, 2, 3, 4, 5],
    '134_0_1_0': [2, 3, 4, 5, 6],
    '134_1_1_0': [1, 2, 3, 5, 6],
    '135_0_0_0': [1, 2, 4, 5, 6],
    '135_1_0_0': [1, 2, 4, 5, 6],
    '136_0_0_1': [1, 2, 4, 5, 6],
    '136_1_0_1': [1, 2, 3, 5, 6],
    '137_0_0_0': [2, 3, 4, 5, 6],
    '137_1_0_0': [1, 2, 3, 4, 5],
    '138_0_0_1': [1, 3, 4, 5, 6],
    '138_1_0_1': [2, 3, 4, 5, 6],
    '139_0_1_1': [1, 2, 3, 4, 5],
    '139_1_1_1': [1, 2, 4, 5, 6],
    '140_0_1_0': [1, 2, 3, 4, 6],
    '140_1_1_0': [1, 2, 3, 4, 5],
    '141_0_1_1': [1, 2, 3, 4, 5],
    '141_1_1_1': [1, 2, 3, 5, 6],
    '142_0_0_1': [1, 2, 3, 5, 6],
    '142_1_0_1': [1, 3, 4, 5, 6],
    '143_0_0_1': [2, 3, 4, 5, 6],
    '143_1_0_1': [1, 3, 4, 5, 6],
    '144_0_1_1': [1, 2, 3, 4, 6],
    '144_1_1_1': [1, 2, 3, 4, 6],
    '145_0_0_1': [1, 3, 4, 5, 6],
    '145_1_0_1': [1, 3, 4, 5, 6],
    '146_0_0_0': [2, 3, 4, 5, 6],
    '146_1_0_0': [2, 3, 4, 5, 6],
    '147_0_1_0': [1, 2, 3, 4, 5],
    '147_1_1_0': [1, 2, 4, 5, 6],
    '148_0_1_0': [1, 3, 4, 5, 6],
    '148_1_1_0': [1, 3, 4, 5, 6],
    '149_0_0_0': [1, 3, 4, 5, 6],
    '149_1_0_0': [1, 3, 4, 5, 6],
    '150_0_0_0': [1, 2, 3, 5, 6],
    '150_1_0_0': [1, 2, 4, 5, 6]
};

// Instructions content as a reusable variable
const INSTRUCTIONS_CONTENT = `
    <div style="text-align: center; max-width: 800px; margin: 0 auto;">
        <h2>Instructions</h2>
        <p>On each trial you will see two images side by side. The image on the left is the source image, and the image on the right is generated by a large AI model.</p>
        
        <div style="display: flex; justify-content: center; gap: 20px; margin: 20px 0;">
            <div style="border: 2px solid #333; padding: 10px; background: #f0f0f0;">
                <strong>Source Image</strong><br>
                (Occluded shape)
            </div>
            <div style="border: 2px solid #333; padding: 10px; background: #f0f0f0;">
                <strong>Model Image</strong><br>
                (AI-generated completion)
            </div>
        </div>
        
        <p>The source image is an occluded shape which served as an input to the AI. The AI was then tasked to complete the occluded part of the image with the following instructions:</p>
        
        <div style="background: #f9f9f9; border-left: 4px solid #007acc; padding: 15px; margin: 20px 0; text-align: left; font-style: italic;">
            "This is an image of a black silhouette on a light gray background, partially covered by a dark grey quadrilateral occluder. Remove the occluder and fill in the occluded region in a natural way that completes the silhouette. Do not modify any part of the silhouette that is visible outside the occluder. That is, everything outside the occlusion must remain pixel-identical to the original image. Only replace the occluded region with pixels that plausibly belong to the silhouette, maintaining the overall visual consistency and realism of the figure."
        </div>
        
        <p>Your job will be to identify for each pair, how well you think the AI did in listening to the instructions and performing the task within the rules.</p>
        
        <p><strong>NOTE:</strong> You are not asked to indicate whether you would complete the shape in the same way, just to what extent the model did what was asked.</p>
        
        <p>Please rate each generation from 1-100 using the slider.</p>
    </div>
`;

// Function to add persistent instructions button
function addInstructionsButton() {
    // Remove existing button if it exists
    const existingButton = document.getElementById('persistent-instructions-btn');
    if (existingButton) {
        existingButton.remove();
    }
    
    // Create button
    const button = document.createElement('button');
    button.id = 'persistent-instructions-btn';
    button.innerHTML = 'ðŸ“– Instructions';
    button.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #007acc;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    `;
    
    // Add hover effect
    button.addEventListener('mouseenter', () => {
        button.style.background = '#005fa3';
    });
    button.addEventListener('mouseleave', () => {
        button.style.background = '#007acc';
    });
    
    // Add click handler to show instructions modal
    button.addEventListener('click', showInstructionsModal);
    
    document.body.appendChild(button);
}

// Function to show instructions modal
function showInstructionsModal() {
    // Create modal overlay
    const modal = document.createElement('div');
    modal.id = 'instructions-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
    `;
    
    // Create modal content
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    `;
    
    // Add close button
    const closeButton = document.createElement('button');
    closeButton.innerHTML = 'âœ•';
    closeButton.style.cssText = `
        position: absolute;
        top: 10px;
        right: 15px;
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #666;
    `;
    closeButton.addEventListener('click', () => {
        document.body.removeChild(modal);
    });
    
    // Add instructions content
    modalContent.innerHTML = INSTRUCTIONS_CONTENT;
    modalContent.appendChild(closeButton);
    
    // Add close instruction
    const closeInstruction = document.createElement('p');
    closeInstruction.innerHTML = '<strong>Click the X or click outside this window to close</strong>';
    closeInstruction.style.cssText = 'text-align: center; margin-top: 20px; color: #666;';
    modalContent.appendChild(closeInstruction);
    
    modal.appendChild(modalContent);
    
    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            document.body.removeChild(modal);
        }
    });
    
    // Close modal with Escape key
    const escapeHandler = (e) => {
        if (e.key === 'Escape') {
            document.body.removeChild(modal);
            document.removeEventListener('keydown', escapeHandler);
        }
    };
    document.addEventListener('keydown', escapeHandler);
    
    document.body.appendChild(modal);
}

// Generate source images from the exact list
function generateSourceImages() {
    return SOURCE_IMAGES.map(img => ({
        stimId: img.stimId,
        naturalNovel: img.naturalNovel,
        symmetry: img.symmetry,
        length: img.length,
        filename: `${img.stimId}_${img.naturalNovel}_${img.symmetry}_${img.length}_2_overlaid.png`,
        path: `Images/Source_Images/${img.stimId}_${img.naturalNovel}_${img.symmetry}_${img.length}_2_overlaid.png`
    }));
}

// Generate model filename based on model type
function generateModelFilename(sourceImage, model, iteration) {
    const base = `${sourceImage.stimId}_${sourceImage.naturalNovel}_${sourceImage.symmetry}_${sourceImage.length}_2`;
    
    switch(model) {
        case 'GROK':
            return `${base}_Var${iteration}.jpg`;
        case 'GEMINI':
            return `gemini_completed_${base}net_${iteration}.png`;
        case 'GPT':
            return `whole_shape_${base}GPT4o_var${iteration}.png`;
        default:
            throw new Error(`Unknown model: ${model}`);
    }
}

// Generate all trials using hardcoded GROK availability
function generateTrials() {
    const trials = [];
    const sourceImages = generateSourceImages();
    
    console.log('Generating trials...');
    
    for (const sourceImage of sourceImages) {
        const baseKey = `${sourceImage.stimId}_${sourceImage.naturalNovel}_${sourceImage.symmetry}_${sourceImage.length}`;
        
        for (const model of MODELS) {
            let iterationsToUse;
            
            if (model === 'GROK') {
                // Use the hardcoded GROK variations
                iterationsToUse = GROK_AVAILABILITY[baseKey] || [];
            } else {
                // For GEMINI and GPT, use all 5 iterations
                iterationsToUse = ITERATIONS[model];
            }
            
            for (const iteration of iterationsToUse) {
                const modelFilename = generateModelFilename(sourceImage, model, iteration);
                const modelPath = `Images/${model}/${modelFilename}`;
                
                trials.push({
                    sourceImage: sourceImage.path,
                    modelImage: modelPath,
                    stimId: sourceImage.stimId,
                    naturalNovel: sourceImage.naturalNovel,
                    symmetry: sourceImage.symmetry,
                    length: sourceImage.length,
                    model: model,
                    iteration: iteration
                });
            }
        }
    }
    
    console.log(`Generated ${trials.length} total trials`);
    return trials;
}

// Shuffle array function
function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

// Global variable to store subject ID
let subjectID = '';

// Global variable to store current rating
let currentRating = 50;

// Initialize jsPsych
const jsPsych = initJsPsych({
    show_progress_bar: true,
    on_finish: function() {
        // Remove instructions button
        const button = document.getElementById('persistent-instructions-btn');
        if (button) {
            button.remove();
        }
        
        // Get only the rating trial data we want
        const ratingData = jsPsych.data.get().filter({task: 'rating'});
        
        // Create clean data array with only the columns we want
        const cleanData = ratingData.values().map(trial => ({
            subjectID: trial.subjectID,
            trialNumber: trial.trialNumber,
            stimId: trial.stimId,
            naturalNovel: trial.naturalNovel,
            symmetry: trial.symmetry,
            length: trial.length,
            model: trial.model,
            iteration: trial.iteration,
            rating: trial.rating,
            rt: trial.rt
        }));
        
        // Convert to tab-delimited format manually
        const headers = Object.keys(cleanData[0]).join('\t');
        const rows = cleanData.map(row => Object.values(row).join('\t'));
        const tsvContent = headers + '\n' + rows.join('\n');
        
        // Create and download file
        const blob = new Blob([tsvContent], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${subjectID}_experiment_data.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
        
        // Also display completion message
        document.body.innerHTML = `
            <div style="text-align: center; padding: 50px; max-width: 600px; margin: 0 auto;">
                <h2>Data Saved Successfully!</h2>
                <p>Your data has been saved as: <strong>${subjectID}_experiment_data.txt</strong></p>
                <p>Thank you for participating in this experiment!</p>
            </div>
        `;
    }
});

// Subject ID collection
const subjectIDCollection = {
    type: jsPsychSurveyText,
    questions: [
        {
            prompt: 'Please enter your Subject ID:',
            name: 'subjectID',
            required: true,
            columns: 20
        }
    ],
    button_label: 'Start Experiment',
    on_finish: function(data) {
        subjectID = data.response.subjectID;
        // Add subject ID to all future trials
        jsPsych.data.addProperties({subjectID: subjectID});
    }
};

// Welcome screen
const welcome = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
        <div style="text-align: center; max-width: 800px; margin: 0 auto;">
            <h1>Shape Rating Experiment</h1>
            <p>Welcome to the experiment!</p>
            <p>You will be asked to enter your Subject ID first, then you'll see pairs of images:</p>
            <ul style="text-align: left; display: inline-block;">
                <li>One <strong>source image</strong> (original shape)</li>
                <li>One <strong>model-generated image</strong> (AI-generated shape)</li>
            </ul>
            <p>Your task is to rate how well the AI model followed the task using a slider from 1 to 100.</p>
            <p><strong>1</strong> = Very poor performance<br>
               <strong>100</strong> = Perfect performance</p>
            <p>There are up to 600 trials in total. Take breaks as needed.</p>
            <p>At the end, your data will be automatically saved as a text file.</p>
            <p><strong>Press any key to continue</strong></p>
        </div>
    `,
    choices: "ALL_KEYS"
};

// Instructions
const instructions = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: INSTRUCTIONS_CONTENT + `
        <p><strong>Press any key to see some examples</strong></p>
    `,
    choices: "ALL_KEYS",
    on_start: function() {
        // Add the persistent instructions button when the experiment starts
        addInstructionsButton();
    }
};

// Examples screen
const examples = {
    type: jsPsychHtmlKeyboardResponse,
    stimulus: `
        <div style="text-align: center; max-width: 1000px; margin: 0 auto;">
            <h2>Examples</h2>
            <p>Here are examples to help you understand what good and poor performance look like:</p>
            
            <div style="display: flex; justify-content: center; gap: 50px; margin: 40px 0;">
                <div style="text-align: center; padding: 20px; border: 3px solid #28a745; border-radius: 10px; background: #f8fff8;">
                    <h3 style="color: #28a745; margin-top: 0;">âœ“ Good Example (High Rating)</h3>
                    <p><strong>What good performance looks like:</strong></p>
                    <img src="Images/Examples/Good_example.png" style="max-width: 300px; max-height: 300px; border: 2px solid #333; margin: 10px 0;"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iIzI4YTc0NSIgb3BhY2l0eT0iMC4xIi8+PHRleHQgeD0iMTUwIiB5PSIxNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzI4YTc0NSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+R29vZCBFeGFtcGxlPC90ZXh0Pjx0ZXh0IHg9IjE1MCIgeT0iMTYwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiPihJbWFnZSBub3QgZm91bmQpPC90ZXh0Pjwvc3ZnPic;">
                    <ul style="text-align: left; font-size: 14px; margin-top: 15px;">
                        <li>Follows instructions precisely</li>
                        <li>Completes the shape naturally</li>
                        <li>Maintains visual consistency</li>
                        <li>Only fills the occluded region</li>
                    </ul>
                </div>
                
                <div style="text-align: center; padding: 20px; border: 3px solid #dc3545; border-radius: 10px; background: #fff8f8;">
                    <h3 style="color: #dc3545; margin-top: 0;">âœ— Bad Example (Low Rating)</h3>
                    <p><strong>What poor performance looks like:</strong></p>
                    <img src="Images/Examples/Bad_example.png" style="max-width: 300px; max-height: 300px; border: 2px solid #333; margin: 10px 0;"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2RjMzU0NSIgb3BhY2l0eT0iMC4xIi8+PHRleHQgeD0iMTUwIiB5PSIxNDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iI2RjMzU0NSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+QmFkIEV4YW1wbGU8L3RleHQ+PHRleHQgeD0iMTUwIiB5PSIxNjAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxMiIgZmlsbD0iIzY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSI+KEltYWdlIG5vdCBmb3VuZCk8L3RleHQ+PC9zdmc+Jw==">
                    <ul style="text-align: left; font-size: 14px; margin-top: 15px;">
                        <li>Ignores instructions</li>
                        <li>Unnatural completion</li>
                        <li>Changes visible parts</li>
                        <li>Poor visual quality</li>
                    </ul>
                </div>
            </div>
            
            <div style="background: #e9ecef; padding: 20px; border-radius: 10px; margin: 30px 0;">
                <p style="font-size: 16px; margin: 0;"><strong>Remember:</strong> Rate based on how well the AI followed the specific instructions, not whether you personally like the completion.</p>
            </div>
            
            <p><strong>Press any key to start the experiment</strong></p>
        </div>
    `,
    choices: "ALL_KEYS"
};

// Create trial template
function createTrial(trialData) {
    const uniqueId = `trial-${trialData.trialNumber}`;
    
    return {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            // Reset current rating for new trial
            currentRating = 50;
            
            return `
                <div style="text-align: center;">
                    <div style="display: flex; justify-content: center; gap: 30px; margin: 20px 0;">
                        <div style="text-align: center;">
                            <p><strong>Source Image</strong></p>
                            <img src="${trialData.sourceImage}" style="max-width: 300px; max-height: 300px; border: 2px solid #333;" 
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2Y0ZjRmNCIvPjx0ZXh0IHg9IjE1MCIgeT0iMTUwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkltYWdlIG5vdCBmb3VuZDwvdGV4dD48L3N2Zz4=';">
                        </div>
                        <div style="text-align: center;">
                            <p><strong>Model Image</strong></p>
                            <img src="${trialData.modelImage}" style="max-width: 300px; max-height: 300px; border: 2px solid #333;"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2Y0ZjRmNCIvPjx0ZXh0IHg9IjE1MCIgeT0iMTUwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiPkltYWdlIG5vdCBmb3VuZDwvdGV4dD48L3N2Zz4=';">
                        </div>
                    </div>
                    <div style="margin: 40px 0;">
                        <p style="font-size: 18px; margin-bottom: 20px;">How well did the AI model follow the task?</p>
                        <div style="display: flex; justify-content: center; align-items: center; gap: 20px; margin: 20px 0;">
                            <span>1<br><small>Very Poor</small></span>
                            <input type="range" id="rating-slider-${uniqueId}" min="1" max="100" value="50" 
                                   style="width: 400px; height: 20px;" 
                                   oninput="
                                       document.getElementById('slider-value-${uniqueId}').textContent = this.value;
                                       currentRating = parseInt(this.value);
                                   ">
                            <span>100<br><small>Perfect</small></span>
                        </div>
                        <div id="slider-value-${uniqueId}" style="font-size: 20px; font-weight: bold; margin: 15px 0;">50</div>
                    </div>
                    <p style="font-size: 16px; color: #666;">
                        Adjust the slider to your rating, then <strong>press SPACEBAR</strong> to continue.
                    </p>
                </div>
            `;
        },
        choices: [' '], // Only spacebar
        on_finish: function(data) {
            // Use the global currentRating variable instead of trying to find the slider
            data.rating = currentRating;
        },
        data: {
            task: 'rating',
            stimId: trialData.stimId,
            naturalNovel: trialData.naturalNovel,
            symmetry: trialData.symmetry,
            length: trialData.length,
            model: trialData.model,
            iteration: trialData.iteration,
            sourceImage: trialData.sourceImage,
            modelImage: trialData.modelImage,
            trialNumber: trialData.trialNumber
        }
    };
}

// Initialize and run the experiment
function runExperiment() {
    // Generate and shuffle all trials
    const allTrials = generateTrials();
    const shuffledTrials = shuffleArray(allTrials);

    // Add trial numbers
    shuffledTrials.forEach((trial, index) => {
        trial.trialNumber = index + 1;
    });

    // Create jsPsych trials
    const experimentTrials = shuffledTrials.map(trial => createTrial(trial));

    // Add break screens every 100 trials
    const trialsWithBreaks = [];
    experimentTrials.forEach((trial, index) => {
        trialsWithBreaks.push(trial);
        
        // Add break after every 100 trials (except the last trial)
        if ((index + 1) % 100 === 0 && index + 1 < experimentTrials.length) {
            trialsWithBreaks.push({
                type: jsPsychHtmlKeyboardResponse,
                stimulus: function() {
                    const completed = index + 1;
                    const total = experimentTrials.length;
                    return `
                        <div style="text-align: center;">
                            <h2>Break Time</h2>
                            <p>You've completed ${completed} out of ${total} trials.</p>
                            <p>Take a break if you need one.</p>
                            <p><strong>Press any key when you're ready to continue</strong></p>
                        </div>
                    `;
                },
                choices: "ALL_KEYS"
            });
        }
    });

    // Final screen
    const debrief = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            return `
                <div style="text-align: center;">
                    <h2>Experiment Complete!</h2>
                    <p>Thank you for participating in this experiment.</p>
                    <p>You have completed all ${experimentTrials.length} trials.</p>
                    <p>Your data has been recorded.</p>
                    <p><strong>Press any key to finish</strong></p>
                </div>
            `;
        },
        choices: "ALL_KEYS"
    };

    // Create timeline
    const timeline = [
        welcome,
        subjectIDCollection,
        instructions,
        examples,
        ...trialsWithBreaks,
        debrief
    ];

    // Run the experiment
    jsPsych.run(timeline);
}

// Start the experiment
runExperiment(); 